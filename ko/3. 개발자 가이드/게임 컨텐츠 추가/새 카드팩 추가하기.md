# 새 카드팩 추가하기

## 개요

메이플 듀얼에서 새로운 카드팩을 추가하는 과정을 단계별로 설명합니다. 새 카드팩은 특정 테마나 컨셉을 가진 카드들의 묶음으로, 플레이어들이 구매하여 컬렉션을 확장할 수 있게 해줍니다.

## 1단계: 카드팩 데이터 정의

### CardPack.csv에 새 카드팩 정보 추가
```csv
name,displayName,description,price,cardCount,rarity1Rate,rarity2Rate,rarity3Rate,rarity4Rate,rarity5Rate,iconRUID,packRUID
DragonPack,드래곤 카드팩,고대 드래곤의 힘이 깃든 카드들,2500,5,40,30,20,8,2,dragon_pack_icon,dragon_pack_model
```

**카드팩 속성 설명:**
- `name`: 내부 식별자
- `displayName`: 플레이어에게 보이는 이름
- `description`: 카드팩 설명
- `price`: 구매 가격 (메소)
- `cardCount`: 한 팩당 카드 수량
- `rarity1Rate~rarity5Rate`: 각 희귀도별 확률 (%)
- `iconRUID`: 카드팩 아이콘 리소스
- `packRUID`: 카드팩 3D 모델 리소스

### 카드팩별 카드 풀 정의
```lua
-- CardPackManager.mlua 확장
local DRAGON_PACK_CARDS = {
    -- 일반 카드 (rarity 1)
    Common = {
        "BabyDragon", "DragonScale", "DragonEgg", "WyvernRider",
        "DragonBreath", "ScaledArmor", "DragonFruit", "Dragonling"
    },
    -- 레어 카드 (rarity 2) 
    Rare = {
        "YoungDragon", "DragonMage", "DragonKnight", "WyvernMaster",
        "FireBreath", "IceBreath", "DragonShield"
    },
    -- 에픽 카드 (rarity 3)
    Epic = {
        "AdultDragon", "ElderWyvern", "DragonLord", "DragonSorceress"
    },
    -- 유니크 카드 (rarity 4)
    Unique = {
        "AncientDragon", "CrystalDragon", "ShadowDragon"
    },
    -- 전설 카드 (rarity 5)
    Legendary = {
        "ArchDragon", "DragonGod"
    }
}
```

## 2단계: CardPackManager 확장

### 새 카드팩 등록
```lua
-- CardPackManager.mlua에 드래곤 팩 추가
@ExecSpace("ServerOnly")
method void OnBeginPlay()
    __base:OnBeginPlay()
    
    -- 기존 카드팩들...
    self.cardPools["DragonPack"] = DRAGON_PACK_CARDS
    self.specialEffects["DragonPack"] = "DragonPackOpenEffect"
end
```

### 카드팩 개봉 로직 구현
```lua
method table OpenCardPack(string packName)
    local packData = self:GetPackData(packName)
    if not packData then
        return nil
    end
    
    local cards = {}
    local cardPool = self.cardPools[packName]
    
    for i = 1, packData.cardCount do
        local rarity = self:RollRarity(packData)
        local card = self:SelectRandomCard(cardPool, rarity)
        table.insert(cards, {name = card, rarity = rarity})
    end
    
    -- 보너스 카드 (특별한 조건에서)
    if self:ShouldGetBonusCard(packName) then
        local bonusCard = self:SelectBonusCard(packName)
        table.insert(cards, bonusCard)
    end
    
    return cards
end

method string RollRarity(table packData)
    local roll = math.random(1, 100)
    local cumulative = 0
    
    for i = 5, 1, -1 do -- 높은 희귀도부터 체크
        cumulative += packData["rarity" .. i .. "Rate"]
        if roll <= cumulative then
            return i
        end
    end
    
    return 1 -- 기본값: 일반
end

method string SelectRandomCard(table cardPool, integer rarity)
    local rarityName = self:GetRarityName(rarity)
    local availableCards = cardPool[rarityName]
    
    if not availableCards or #availableCards == 0 then
        -- 해당 희귀도 카드가 없으면 한 단계 아래 희귀도에서 선택
        return self:SelectRandomCard(cardPool, math.max(1, rarity - 1))
    end
    
    return availableCards[math.random(1, #availableCards)]
end
```

### 특별 효과 및 이벤트
```lua
method boolean ShouldGetBonusCard(string packName)
    if packName == "DragonPack" then
        -- 10% 확률로 보너스 드래곤 카드
        return math.random(1, 100) <= 10
    end
    return false
end

method table SelectBonusCard(string packName)
    if packName == "DragonPack" then
        return {
            name = "MythicalDragon", 
            rarity = 6, -- 특별 희귀도
            isBonus = true
        }
    end
    return nil
end
```

## 3단계: 상점 UI 업데이트

### ShopModule에 새 카드팩 추가
```lua
-- ShopModule.mlua 확장
@ExecSpace("ClientOnly")
method void RefreshCardPackList()
    local cardPackManager = self.Entity.CurrentMap.cardPackManager
    local availablePacks = cardPackManager:GetAvailablePacks()
    
    for _, packData in ipairs(availablePacks) do
        local packButton = self:CreateCardPackButton(packData)
        self.cardPackContainer:AddChild(packButton)
    end
end

method Entity CreateCardPackButton(table packData)
    local buttonEntity = _SpawnService:SpawnByModelId(
        _EntryService:GetModelIdByName("CardPackButton"), 
        "CardPackButton"
    )
    
    -- 카드팩 아이콘 설정
    local iconComponent = buttonEntity:GetComponentByType(SpriteRendererComponent)
    iconComponent.SpriteRUID = packData.iconRUID
    
    -- 가격 표시
    local priceText = buttonEntity:GetChild("PriceText").TextComponent
    priceText.String = tostring(packData.price) .. " 메소"
    
    -- 클릭 이벤트
    buttonEntity:ConnectEvent(ButtonClickEvent, function()
        self:PurchaseCardPack(packData.name)
    end)
    
    return buttonEntity
end
```

### 카드팩 구매 처리
```lua
method void PurchaseCardPack(string packName)
    local character = _UserService.LocalPlayer.Character
    if not character.isLoaded or _Server:IsRequesting() then 
        return 
    end
    
    local packData = self.cardPackManager:GetPackData(packName)
    
    -- 가격 확인
    if character.meso < packData.price then
        self.uiManager.PopupModule:ShowMessage("메소가 부족합니다!")
        return
    end
    
    -- 확인 팝업
    self.uiManager.PopupModule:Open("ConfirmPurchase", true, function()
        _Server:Request(character, "BuyCardPack", {packName})
    end)
end
```

## 4단계: 카드팩 개봉 애니메이션

### CardPackModule 확장
```lua
-- CardPackModule.mlua에 새 카드팩 개봉 애니메이션 추가
@ExecSpace("ClientOnly")
method void PlayOpenAnimation(string packName, table cards)
    if packName == "DragonPack" then
        self:PlayDragonPackAnimation(cards)
    else
        self:PlayDefaultOpenAnimation(cards)
    end
end

@ExecSpace("ClientOnly")  
method void PlayDragonPackAnimation(table cards)
    -- 드래곤 팩 전용 이펙트
    _Effect:PlayEffect("DragonFireBurst", Vector3.zero, self.Entity)
    
    -- 카드 등장 애니메이션
    _TimerService:SetTimerOnce(function()
        for i, card in ipairs(cards) do
            _TimerService:SetTimerOnce(function()
                self:RevealCard(card, i)
                if card.rarity >= 4 then -- 유니크 이상
                    _Effect:PlayEffect("DragonRoar", Vector3.zero, self.Entity)
                end
            end, i * 0.5)
        end
    end, 1.0)
end
```

## 5단계: 카드팩 테마 이벤트

### 시즌별 카드팩 활성화
```lua
-- EventManager.mlua (가상의 이벤트 매니저)
method void ActivateSeasonalPack(string season)
    if season == "DragonSeason" then
        -- 드래곤 팩 할인 이벤트
        self.cardPackManager:SetPackDiscount("DragonPack", 0.2) -- 20% 할인
        
        -- 보너스 확률 증가
        self.cardPackManager:SetBonusRate("DragonPack", 0.15) -- 15%로 증가
        
        -- 이벤트 기간 설정
        self:SetEventDuration(7) -- 7일간
    end
end
```

### 일일 무료 팩
```lua
method void CheckDailyFreePack(Character character)
    local lastFreePackDate = character:GetData("lastFreePackDate")
    local today = _DateTime:GetDate()
    
    if lastFreePackDate ~= today then
        -- 오늘 첫 방문 시 무료 팩 지급
        character:SetData("lastFreePackDate", today)
        self:GiveFreeCardPack(character, "BasicPack")
    end
end
```

## 6단계: 수집 시스템 연동

### 카드 도감 업데이트
```lua
-- CardModule.mlua에서 새 카드팩 카드들 도감 추가
method void UpdateCollection(Character character, table newCards)
    for _, card in ipairs(newCards) do
        if not character:HasCard(card.name) then
            character:AddToCollection(card.name)
            
            -- 첫 획득 시 특별 효과
            if self:IsRareCard(card) then
                self:ShowFirstTimeCollection(card)
            end
        end
    end
end

method void ShowFirstTimeCollection(table card)
    _Effect:PlayEffect("NewCardCollection", Vector3.zero, self.Entity)
    
    self.uiManager.PopupModule:ShowMessage(
        string.format("새로운 %s 카드를 획득했습니다!", card.name)
    )
end
```

## 7단계: 밸런스 및 확률 조정

### 카드팩 확률 모니터링
```lua
method table GetPackOpeningStats(string packName)
    local stats = {
        totalOpened = 0,
        rarityDistribution = {0, 0, 0, 0, 0},
        averageValue = 0
    }
    
    -- 플레이어들의 카드팩 개봉 데이터 수집
    for _, character in ipairs(self:GetAllCharacters()) do
        local characterStats = character:GetPackStats(packName)
        stats.totalOpened += characterStats.opened
        
        for i = 1, 5 do
            stats.rarityDistribution[i] += characterStats.rarityCount[i]
        end
    end
    
    return stats
end

method void AdjustPackRates(string packName)
    local stats = self:GetPackOpeningStats(packName)
    local expectedRates = self:GetExpectedRates(packName)
    
    -- 실제 확률과 예상 확률 비교하여 조정
    for i = 1, 5 do
        local actualRate = stats.rarityDistribution[i] / stats.totalOpened * 100
        local expectedRate = expectedRates[i]
        
        if math.abs(actualRate - expectedRate) > 2 then -- 2% 이상 차이나면
            self:AdjustRarityRate(packName, i, expectedRate)
        end
    end
end
```

## 8단계: 리소스 및 현지화

### 다국어 지원
```lua
-- 카드팩 이름과 설명 현지화
local PACK_LOCALIZATION = {
    ko = {
        DragonPack = {
            name = "드래곤 카드팩",
            description = "고대 드래곤의 힘이 깃든 전설의 카드들을 획득할 수 있습니다."
        }
    },
    en = {
        DragonPack = {
            name = "Dragon Card Pack", 
            description = "Obtain legendary cards imbued with ancient dragon power."
        }
    }
}
```

### 리소스 최적화
```lua
method void PreloadPackResources(string packName)
    local packData = self:GetPackData(packName)
    
    -- 카드팩 관련 리소스 미리 로드
    _ResourceService:PreloadAsync({
        packData.iconRUID,
        packData.packRUID,
        self.specialEffects[packName]
    })
end
```

## 완료 체크리스트

- [ ] CardPack.csv에 새 카드팩 데이터 추가
- [ ] CardPackManager에 카드 풀과 개봉 로직 구현
- [ ] ShopModule UI에 새 카드팩 추가
- [ ] 카드팩 개봉 애니메이션 구현
- [ ] 수집 시스템과 연동
- [ ] 확률 및 밸런스 테스트
- [ ] 리소스 최적화 및 현지화
- [ ] 이벤트 시스템과 연동 (선택사항)

## 참고 자료

- `1. 핵심 아키텍처/경제 시스템/카드팩 시스템.md` - 카드팩 시스템 상세 설명
- `1. 핵심 아키텍처/경제 시스템/상점 시스템.md` - 상점 시스템 연동
- `3. 개발자 가이드/게임 컨텐츠 추가/새 카드 추가하기.md` - 카드 추가 방법

새 카드팩 추가는 게임의 수익성과 플레이어 참여도에 직접적인 영향을 미치는 중요한 콘텐츠입니다. 이 가이드를 통해 매력적이고 균형 잡힌 카드팩을 만들어보세요.
