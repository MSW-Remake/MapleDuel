# ë­í¬ ë§¤ì¹˜ ì‹œìŠ¤í…œ

## ğŸ“‹ ê°œìš”

ë­í¬ ë§¤ì¹˜ ì‹œìŠ¤í…œì€ ë©”ì´í”Œ ë“€ì–¼ì˜ ê²½ìŸì  ê²Œì„í”Œë ˆì´ì˜ í•µì‹¬ìœ¼ë¡œ, ELO ê¸°ë°˜ MMR(Match Making Rating) ì‹œìŠ¤í…œê³¼ 6ë‹¨ê³„ í‹°ì–´ êµ¬ì¡°ë¥¼ í†µí•´ ê³µì •í•˜ê³  ê· í˜•ì¡íŒ ë§¤ì¹­ í™˜ê²½ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ ì‹œìŠ¤í…œì€ 500~2500 ë­í¬ í¬ì¸íŠ¸ ë²”ìœ„ì—ì„œ Ironë¶€í„° Legendê¹Œì§€ì˜ í‹°ì–´ë¥¼ ìš´ì˜í•˜ë©°, ìŠ¹íŒ¨ì— ë”°ë¥¸ ë™ì  ì ìˆ˜ ì¡°ì •, ì¼ì¼ ë³´ìƒ ì‹œìŠ¤í…œ, ê·¸ë¦¬ê³  ì‹¤ì‹œê°„ ë¦¬ë”ë³´ë“œë¥¼ í†µí•´ í”Œë ˆì´ì–´ë“¤ì˜ ì§€ì†ì ì¸ ê²½ìŸ ì˜ìš•ì„ ìê·¹í•©ë‹ˆë‹¤.

**ê´€ë ¨ íŒŒì¼**:
- `RootDesk/MyDesk/Components/Managers/RankManager.mlua` - í‹°ì–´ ì‹œìŠ¤í…œ ë° ë­í¬ ê³„ì‚°
- `RootDesk/MyDesk/Components/Home.mlua` - ELO ë§¤ì¹­ ë° ë­í¬ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
- `RootDesk/MyDesk/Logics/Matching.mlua` - ë¦¬ë”ë³´ë“œ ì‹œìŠ¤í…œ
- `RootDesk/MyDesk/Components/Objects/Duel.mlua` - ë§¤ì¹˜ ê²°ê³¼ ì²˜ë¦¬

## ğŸ—ï¸ ë­í¬ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### í‹°ì–´ ë° ë­í¬ êµ¬ì¡°

```mermaid
graph TB
    A[ë­í¬ í¬ì¸íŠ¸ ë²”ìœ„] --> B[Iron 500-899]
    A --> C[Bronze 900-1299]
    A --> D[Silver 1300-1699]
    A --> E[Gold 1700-2099]
    A --> F[Platinum 2100-2499]
    A --> G[Master 2500+]
    A --> H[Legend 2500+ + 1ìœ„]
    
    B --> I[ì„¸ë¶€ í‹°ì–´<br/>Iron 4-1]
    C --> I
    D --> I
    E --> I
    F --> I
    
    G --> J[ë§ˆìŠ¤í„°<br/>ì„¸ë¶€ í‹°ì–´ ì—†ìŒ]
    H --> J
    
    style G fill:#ffcccc
    style H fill:#ccffcc
```

## ğŸ† 1. í‹°ì–´ ì‹œìŠ¤í…œ

### ë©”ì´ì € ë­í¬ ê³„ì‚°

#### 6ë‹¨ê³„ í‹°ì–´ êµ¬ì¡°
```lua
method string GetMajorRank(integer rankPoint, integer ranking)
    -- Legend: 2500ì  ì´ìƒ + 1ìœ„
    if rankPoint >= 2500 and ranking > 0 and ranking == 1 then
        return "Legend"
    end
    
    -- Iron~Master: 400ì  êµ¬ê°„ë³„ ë¶„í• 
    local majorRankArray = {"Iron", "Bronze", "Silver", "Gold", "Platinum", "Master"}
    return majorRankArray[math.floor((math.min(rankPoint, 2500) - 500) / 400) + 1]
end
```

#### ë§ˆì´ë„ˆ ë­í¬ ê³„ì‚° (ì„¸ë¶€ í‹°ì–´)
```lua
method integer GetMinorRank(integer rankPoint)
    local majorRank = self:GetMajorRank(rankPoint, 0)
    
    -- Master, Legendì€ ì„¸ë¶€ í‹°ì–´ ì—†ìŒ
    if majorRank == "Master" or majorRank == "Legend" then
        return
    else
        -- 4-3-2-1 (ë†’ì„ìˆ˜ë¡ ê³ í‹°ì–´)
        return 4 - math.floor(((rankPoint - 500) % 400) / 100)
    end
end
```

### í‹°ì–´ëª… ë° í¬ì¸íŠ¸ í‘œì‹œ

#### í†µí•© ë­í¬ ì •ë³´ ì‹œìŠ¤í…œ
```mermaid
graph TB
    A[ë­í¬ í¬ì¸íŠ¸ 1350] --> B[GetMajorRank]
    A --> C[GetMinorRank]
    A --> D[GetRankPoint]
    
    B --> E[Silver]
    C --> F[2]
    D --> G[50 P]
    
    E --> H[Silver 2<br/>50 P]
    F --> H
    G --> H
    
    style H fill:#ffffcc
```

#### ë­í¬ í‘œì‹œ ë¡œì§
```lua
method string GetRankName(integer rankPoint, integer ranking)
    local majorRank = self:GetMajorRank(rankPoint, ranking)
    
    if majorRank == "Master" or majorRank == "Legend" then
        return _LocalizationService:GetText(majorRank)
    else
        return string.format("%s %d", _LocalizationService:GetText(majorRank), self:GetMinorRank(rankPoint))
    end
end

method string GetRankPoint(integer rankPoint)
    local majorRank = self:GetMajorRank(rankPoint, 0)
    local remainder
    
    if majorRank == "Master" or majorRank == "Legend" then
        remainder = rankPoint - 2500  -- ë§ˆìŠ¤í„° ì´ìƒì€ 2500 ì´ˆê³¼ë¶„ í‘œì‹œ
    else
        remainder = rankPoint % 100   -- ì¼ë°˜ í‹°ì–´ëŠ” 100ë‹¨ìœ„ ë‚˜ë¨¸ì§€
    end
    
    return string.format("%d P", remainder)
end
```

## ğŸ“Š 2. ELO ê¸°ë°˜ ë§¤ì¹­ ì‹œìŠ¤í…œ

### MMR ë° ë­í¬ í¬ì¸íŠ¸ ê´€ê³„

#### ì´ì¤‘ ë ˆì´íŒ… ì‹œìŠ¤í…œ
```lua
-- Home.mluaì—ì„œ ë§¤ì¹˜ ê²°ê³¼ ì²˜ë¦¬
local befMmr = result.befMmr
local afterMmr
if matchResultInfo == nil then
    afterMmr = befMmr  -- ë¬´íš¨ ê²Œì„
else
    if userId == matchResultInfo.Home.UserId then
        afterMmr = matchResultInfo.Home.Score
    else
        afterMmr = matchResultInfo.Away.Score
    end
end

-- MMRì„ ë­í¬ í¬ì¸íŠ¸ë¡œ ë³€í™˜
local targetRankPoint = 2 * (afterMmr - 1500) + 1500
local bonus = math.floor((targetRankPoint - befRankPoint) / 40)
```

**ì´ì¤‘ ì‹œìŠ¤í…œì˜ ì¥ì **:
- **MMR**: ì‹¤ì œ ì‹¤ë ¥ ê¸°ë°˜ ë§¤ì¹­ (ìˆ¨ê²¨ì§„ ì ìˆ˜)
- **ë­í¬ í¬ì¸íŠ¸**: í”Œë ˆì´ì–´ì—ê²Œ í‘œì‹œë˜ëŠ” ì ìˆ˜
- **ì™„ì¶© íš¨ê³¼**: ê¸‰ê²©í•œ ë­í¬ ë³€ë™ ë°©ì§€
- **ì •í™•í•œ ë§¤ì¹­**: ì‹¤ë ¥ ì°¨ì´ ìµœì†Œí™”

### ë™ì  ì ìˆ˜ ì¡°ì •

#### ìŠ¹íŒ¨ë³„ ì ìˆ˜ ë³€í™” ê³„ì‚°
```lua
local delta
if _UtilLogic:IsNilorEmptyString(winnerUserId) then
    delta = 0  -- ë¬´ìŠ¹ë¶€
elseif winnerUserId == userId then
    -- ìŠ¹ë¦¬: 10~40ì  íšë“ (ë³´ë„ˆìŠ¤ í¬í•¨)
    delta = math.max(math.min(20 + bonus, 40), 10)
else
    -- íŒ¨ë°°: -10~-40ì  ì†ì‹¤ (ë³´ë„ˆìŠ¤ í¬í•¨)
    delta = math.min(math.max(-20 + bonus, -40), -10)
end

local afterRankPoint = math.max(befRankPoint + delta, 500)  -- ìµœì†Œ 500ì  ë³´ì¥
```

#### ë³´ë„ˆìŠ¤ ì‹œìŠ¤í…œ
```mermaid
graph TB
    A[MMR vs ë­í¬í¬ì¸íŠ¸ ì°¨ì´] --> B[ë³´ë„ˆìŠ¤ ê³„ì‚°]
    B --> C{MMRì´ ë†’ì€ê°€?}
    
    C -->|Yes| D[ì–‘ìˆ˜ ë³´ë„ˆìŠ¤<br/>ë¹ ë¥¸ ìƒìŠ¹]
    C -->|No| E[ìŒìˆ˜ ë³´ë„ˆìŠ¤<br/>ëŠë¦° í•˜ë½]
    
    D --> F[ìŠ¹ë¦¬ ì‹œ ë” ë§ì€ ì ìˆ˜<br/>íŒ¨ë°° ì‹œ ì ì€ ì†ì‹¤]
    E --> G[ìŠ¹ë¦¬ ì‹œ ì ì€ ì ìˆ˜<br/>íŒ¨ë°° ì‹œ ë§ì€ ì†ì‹¤]
    
    style D fill:#ccffcc
    style E fill:#ffcccc
```

**ë³´ë„ˆìŠ¤ ì‹œìŠ¤í…œì˜ ëª©ì **:
- **ë¹ ë¥¸ ì¡°ì •**: ì‹¤ë ¥ ëŒ€ë¹„ ì˜ëª»ëœ í‹°ì–´ì— ìˆì„ ë•Œ ë¹ ë¥¸ ìˆ˜ì •
- **ìŠ¤ë¨¸í”„ ë°©ì§€**: ìˆ™ë ¨ìê°€ ë‚®ì€ í‹°ì–´ì— ë¨¸ë¬´ë¥´ëŠ” ê²ƒ ë°©ì§€
- **ê³µì •ì„±**: ì—°ìŠ¹ ì‹œ ë¹ ë¥¸ ìƒìŠ¹, ì—°íŒ¨ ì‹œ ì ì§„ì  í•˜ë½

## ğŸ 3. ë³´ìƒ ì‹œìŠ¤í…œ

### ë‹¤ì¸µ ë³´ìƒ êµ¬ì¡°

#### ë§¤ì¹˜ ì™„ë£Œ ë³´ìƒ
```lua
-- Duel.mluaì—ì„œ ë³´ìƒ ê³„ì‚°
local playMesoDelta = 100  -- ê¸°ë³¸ ì°¸ì—¬ ë³´ìƒ

local rankedWinMesoDelta
if isRankedMatch and player == winner then
    rankedWinMesoDelta = math.floor(math.min(
        (hotTime and 1.5 or 1) * 450, 
        math.max(0, 4500 - character:GetDailyRankedWinMeso())
    ))
    character:AddDailyRankedWinMeso(rankedWinMesoDelta)
end
```

#### ì¼ì¼ í™œë™ ë³´ìƒ
```lua
local rankedPlayMesoDelta
local dailyRankedPlayCount
if isRankedMatch and self.startDate ~= nil and 
   DateTime.UtcNow - DateTime(self.startDate) > TimeSpan(0, 1, 0) and 
   self.history:GetThisGameMp(player) >= 6 then
    
    character:IncreaseDailyRankedPlayCount()
    dailyRankedPlayCount = character:GetDailyRankedPlayCount()
    
    if dailyRankedPlayCount == 1 then
        rankedPlayMesoDelta = 1000    -- ì²« ê²Œì„ ë³´ë„ˆìŠ¤
    elseif dailyRankedPlayCount == 3 then
        rankedPlayMesoDelta = 2000    -- 3ê²Œì„ ë‹¬ì„±
    elseif dailyRankedPlayCount == 6 then
        rankedPlayMesoDelta = 3000    -- 6ê²Œì„ ë‹¬ì„±
    end
end
```

### ë­í¬ ìƒìŠ¹ ë³´ìƒ

#### ë‹¨ê³„ë³„ ìŠ¹ê¸‰ ë³´ë„ˆìŠ¤
```lua
local rankMesoDelta
if isRankedMatch then
    local rankPoint = character.rankPoint
    local topRankPoint = character.topRankPoint
    
    -- 100ì  ë‹¨ìœ„ ìŠ¹ê¸‰ ë³´ìƒ
    local mesoArray = {500, 500, 500, 3000, 500, 500, 500, 5000, 1000, 1000, 1000, 10000, 1000, 1000, 1000, 20000, 3000, 3000, 3000, 40000}
    for i, meso in ipairs(mesoArray) do
        local hurdle = 500 + i * 100
        if topRankPoint < hurdle and hurdle <= rankPoint then
            rankMesoDelta = rankMesoDelta and rankMesoDelta + meso or meso
        end
    end

    if rankPoint > topRankPoint then
        character:SetTopRankPoint(rankPoint)  -- ìµœê³  ë­í¬ ê°±ì‹ 
    end
end
```

### ë³´ìƒ ì²´ê³„ ë¶„ì„

#### ë³´ìƒ ì¢…ë¥˜ë³„ ëª©ì 
```mermaid
graph TB
    A[ë³´ìƒ ì‹œìŠ¤í…œ] --> B[ì°¸ì—¬ ìœ ë„]
    A --> C[ìŠ¹ë¥  í–¥ìƒ ë™ê¸°]
    A --> D[ì¥ê¸° ëª©í‘œ ì„¤ì •]
    A --> E[ê²½ì œ ìˆœí™˜]
    
    B --> F[PlayMeso<br/>ê¸°ë³¸ ì°¸ì—¬ ë³´ìƒ]
    C --> G[RankedWinMeso<br/>ìŠ¹ë¦¬ ì¶”ê°€ ë³´ìƒ]
    D --> H[RankMeso<br/>ìŠ¹ê¸‰ ë³´ë„ˆìŠ¤]
    E --> I[ì¼ì¼ í•œë„<br/>ì¸í”Œë ˆì´ì…˜ ë°©ì§€]
    
    style F fill:#ffffcc
    style G fill:#ccffcc
    style H fill:#ffcccc
```

## ğŸ… 4. ë¦¬ë”ë³´ë“œ ì‹œìŠ¤í…œ

### ì‹¤ì‹œê°„ ë­í‚¹ ê´€ë¦¬

#### SortableDataStorage í™œìš©
```lua
@ExecSpace("ServerOnly")
method void GetRankingInfos()
    local sortableDataStorage = _DataStorageService:GetSortableDataStorage("Ranking")
    local resultCode, pages = sortableDataStorage:GetSortedAndWait(SortDirection.Descending, 0, 100000)
    
    local rankingInfoArray = {}
    local count = 1
    
    while true do
        local items = pages:GetCurrentPageDatas()
        for _, item in pairs(items) do
            local userId = item.KeyInfo.Key
            local nickname = item.KeyInfo.Tag
            local rankPoint = item.Value
            
            table.insert(rankingInfoArray, {
                nickname = nickname, 
                rankPoint = rankPoint, 
                ranking = count
            })
            
            count += 1
            if count > 100 then break end  -- ìƒìœ„ 100ìœ„ê¹Œì§€
        end
        
        if count > 100 or pages.IsLastPage then break end
        pages:MoveToNextPageAndWait()
    end
    
    self:GetRankingInfosInSender(rankingInfoArray, senderUserId)
end
```

### ë¦¬ë”ë³´ë“œ ë°ì´í„° ê´€ë¦¬

#### ë­í‚¹ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ
```mermaid
sequenceDiagram
    participant D as Duel End
    participant H as Home
    participant SDS as SortableDataStorage
    participant RM as RankManager
    participant UI as RankingUI
    
    D->>H: ë§¤ì¹˜ ê²°ê³¼ ì „ë‹¬
    H->>H: ìƒˆ ë­í¬ í¬ì¸íŠ¸ ê³„ì‚°
    H->>SDS: SetByInfo(userId, newRankPoint)
    SDS-->>H: ì—…ë°ì´íŠ¸ ì™„ë£Œ
    
    UI->>RM: GetRankingInfos() ìš”ì²­
    RM->>SDS: GetSorted(ìƒìœ„ 100ëª…)
    SDS-->>RM: ì •ë ¬ëœ ë­í‚¹ ë°ì´í„°
    RM->>UI: ë­í‚¹ ì •ë³´ ì „ë‹¬
```

## ğŸ”’ 5. ë§¤ì¹­ ë¬´ê²°ì„± ë³´ì¥

### ê²Œì„ ìœ íš¨ì„± ê²€ì‚¬

#### ìµœì†Œ í”Œë ˆì´ ì¡°ê±´
```lua
-- 1ë¶„ ì´ìƒ + 6MP ì´ìƒ ì‚¬ìš©í•œ ê²Œì„ë§Œ ì¸ì •
if isRankedMatch and self.startDate ~= nil and 
   DateTime.UtcNow - DateTime(self.startDate) > TimeSpan(0, 1, 0) and 
   self.history:GetThisGameMp(player) >= 6 then
    
    -- ìœ íš¨í•œ ë­í¬ ê²Œì„ìœ¼ë¡œ ì¸ì •
    character:IncreaseDailyRankedPlayCount()
end
```

### ì–´ë·°ì§• ë°©ì§€

#### ì ìˆ˜ ì¡°ì‘ ë°©ì§€ ì‹œìŠ¤í…œ
```lua
-- ìµœì†Œ ë­í¬ í¬ì¸íŠ¸ ë³´ì¥ (500ì  ì´í•˜ë¡œ ë–¨ì–´ì§€ì§€ ì•ŠìŒ)
local afterRankPoint = math.max(befRankPoint + delta, 500)

-- ì ìˆ˜ ë³€í™”ëŸ‰ ì œí•œ (í•œ ê²Œì„ë‹¹ ìµœëŒ€ Â±40ì )
delta = math.max(math.min(20 + bonus, 40), 10)      -- ìŠ¹ë¦¬
delta = math.min(math.max(-20 + bonus, -40), -10)   -- íŒ¨ë°°
```

## ğŸ“ˆ 6. ì‹œì¦Œ ì‹œìŠ¤í…œ (í™•ì¥ ê°€ëŠ¥)

### ë¯¸ë˜ í™•ì¥ì„± ê³ ë ¤

#### ì‹œì¦Œ êµ¬ì¡° ì„¤ê³„
```lua
-- í™•ì¥ ì˜ˆì‹œ (ë¯¸êµ¬í˜„)
method void StartNewSeason()
    -- ëª¨ë“  í”Œë ˆì´ì–´ ë­í¬ í¬ì¸íŠ¸ ë¦¬ì…‹
    local resetPoint = math.max(500, currentRankPoint * 0.8)
    
    -- ì‹œì¦Œ ë³´ìƒ ì§€ê¸‰
    local seasonReward = self:CalculateSeasonReward(finalRank)
    
    -- ìƒˆ ì‹œì¦Œ ì‹œì‘
    self:InitializeSeasonData(newSeasonId)
end
```

#### ì‹œì¦Œë³„ ë©”íƒ€ ë³€í™”
- **ì¹´ë“œ ë°¸ëŸ°ìŠ¤**: ì‹œì¦Œë§ˆë‹¤ ì¹´ë“œ íš¨ê³¼ ì¡°ì •
- **ìƒˆ ë³´ìƒ**: ì‹œì¦Œ ì „ìš© ì¹´ë“œë°±, íƒ€ì´í‹€ ë“±
- **íŠ¹ë³„ ì´ë²¤íŠ¸**: ì‹œì¦Œ ì¤‘ íŠ¹ë³„ ë§¤ì¹­ ëª¨ë“œ

## ğŸ’¡ ì½”ë“œ ì°¸ì¡°

ë­í¬ ë§¤ì¹˜ ì‹œìŠ¤í…œ í•µì‹¬ ë¡œì§:
- `RankManager.mlua :: GetMajorRank()` â€” í‹°ì–´ ê³„ì‚° ë¡œì§
- `Home.mlua :: UpdateMatchResult()` â€” ELO ê¸°ë°˜ ë­í¬ í¬ì¸íŠ¸ ê³„ì‚°
- `Duel.mlua :: EndMatch()` â€” ë§¤ì¹˜ ê²°ê³¼ ì²˜ë¦¬ ë° ë³´ìƒ ì§€ê¸‰
- `RankManager.mlua :: GetRankingInfos()` â€” ì‹¤ì‹œê°„ ë¦¬ë”ë³´ë“œ ê´€ë¦¬
- `Matching.mlua :: GetOrCreateLeaderBoard()` â€” ë¦¬ë”ë³´ë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”

ë­í¬ ë§¤ì¹˜ ì‹œìŠ¤í…œì€ ë©”ì´í”Œ ë“€ì–¼ì˜ ê²½ìŸì  ê²Œì„í”Œë ˆì´ë¥¼ ì§€ì›í•˜ëŠ” í•µì‹¬ ì‹œìŠ¤í…œìœ¼ë¡œ, ELO ê¸°ë°˜ì˜ ê³µì •í•œ ë§¤ì¹­ê³¼ ë‹¤ì¸µì  ë³´ìƒ êµ¬ì¡°ë¥¼ í†µí•´ í”Œë ˆì´ì–´ë“¤ì˜ ì§€ì†ì ì¸ ì°¸ì—¬ì™€ ì‹¤ë ¥ í–¥ìƒì„ ìœ ë„í•˜ë©°, í™•ì¥ ê°€ëŠ¥í•œ ì„¤ê³„ë¥¼ í†µí•´ ë¯¸ë˜ì˜ ì‹œì¦Œ ì‹œìŠ¤í…œì´ë‚˜ ì¶”ê°€ ê¸°ëŠ¥ì„ ì‰½ê²Œ í†µí•©í•  ìˆ˜ ìˆë„ë¡ êµ¬ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤.
