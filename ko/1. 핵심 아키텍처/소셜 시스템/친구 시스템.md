# 친구 시스템

## 개요

메이플 듀얼의 친구 시스템은 플레이어 간의 사회적 상호작용을 가능하게 하는 핵심 소셜 기능입니다. 친구 추가/삭제, 친구 요청 관리, 온라인 상태 확인, 친구 팔로우(따라가기) 등의 기능을 제공합니다.

## 핵심 컴포넌트

### SocialModule.mlua
소셜 UI의 메인 인터페이스로, 친구 목록 표시와 친구 요청 처리를 담당합니다.

**주요 기능:**
- 친구 목록 페이지네이션 표시 (7명씩 페이지별 표시)
- 친구 요청 팝업 처리
- 실시간 친구 상태 업데이트 (5초마다 갱신)
- 랭크 및 프로필 정보 표시

```lua
-- 친구 목록을 페이지 단위로 표시하는 핵심 로직
method void ShowFriendSlots(integer pageIndex)
    self.pageIndex = pageIndex
    
    local character = _UserService.LocalPlayer.Character
    local start = 1 + 7 * (pageIndex - 1)
    local finish = math.min(7 * pageIndex, #self.userIdArray)
    local userIdArray = {}
    for i = start, finish do
        table.insert(userIdArray, self.userIdArray[i])
    end
    _Server:Request(character.Entity.CurrentMap.Map, "GetFriends", {character, userIdArray})
end
```

### InteractionModule.mlua
다른 플레이어와의 직접적인 상호작용을 처리하는 컴포넌트입니다.

**주요 기능:**
- 다른 플레이어에게 친구 신청 보내기
- 기존 친구와의 친구 관계 해제
- 대상 플레이어의 위치에 따른 UI 포지셔닝

```lua
-- 친구 신청/해제 버튼 상태 관리
method void SetFriendButton(boolean isFriendWithOther)
    self.isFriendWithOther = isFriendWithOther
    
    local resource = self.resourceManager:GetResource("InteractionModule")
    if self.isFriendWithOther then
        self.friendButton.Entity.SpriteGUIRendererComponent.ImageRUID = resource.unfriend
        self.friendButtonText.Text = _LocalizationService:GetText("Unfriend")
    else
        self.friendButton.Entity.SpriteGUIRendererComponent.ImageRUID = resource.friendRequest
        self.friendButtonText.Text = _LocalizationService:GetText("FriendRequest")
    end
end
```

### FriendSlot.mlua
개별 친구의 정보를 표시하고 관리하는 슬롯 컴포넌트입니다.

**주요 기능:**
- 온라인/오프라인 친구 상태 구분 표시
- 친구의 현재 위치 정보 표시 (채널, 방, 게임 모드)
- 친구 삭제 및 팔로우 기능

```lua
-- 온라인 친구 정보 설정
method void SetFriendOnline(string userId, table friend)
    self.userId = userId
    self.friend = friend
    
    self.rankImage.ImageRUID = self.resourceManager:GetResource("Rank")[friend.majorRank]
    self.nicknameText.Text = friend.nickname
    self.profileCodeText.Text = "#" .. friend.profileCode
    
    local location = friend.location
    local mode = location.mode
    if mode == "Lobby" then
        self.locationText.Text = string.format("%s %d", _LocalizationService:GetText("Channel"), location.channel.id) 
    elseif mode == "RankedMatch" then
        self.locationText.Text = _LocalizationService:GetText("RankedMatch")
    -- ... 기타 모드별 위치 표시
    end
end
```

## 서버 측 친구 관리 (Character.mlua)

### 친구 관계 확인

```lua
method boolean IsFriendWith(Character character)
    return self:IsUser() and self.friendTable[character.Entity.Name] ~= nil
end

method integer GetFriendCount()
    return _Table:GetSize(self.friendTable)
end
```

### 친구 요청 시스템

**친구 신청 보내기:**
```lua
@ExecSpace("ServerOnly")
method void SendFriendRequest(Character other)
    if not self.isLoaded then return end
    
    local result
    if not isvalid(other) or not other.isLoaded then
        result = "UserNotFound"
    elseif _Table:Contains(other.friendRequestArray, self) then
        result = "Pending"
    elseif self:IsFriendWith(other) then
        result = "FriendAlready"
    else
        result = "Success"
    end
    
    if result == "Success" then
        table.insert(other.friendRequestArray, self)
        self:SendFriendRequestInOther(other.Entity.Name)
    end
    
    self:SendFriendRequestInOwner(result, self.Entity.Name)
end
```

**친구 요청 수락:**
```lua
@ExecSpace("ServerOnly")
method void AcceptFriendRequest(Character sender)
    if result == "Success" then
        self.friendTable[sender.Entity.Name] = {
            profileCode = sender.profileCode, 
            nickname = sender.nickname
        }
        sender.friendTable[self.Entity.Name] = {
            profileCode = self.profileCode, 
            nickname = self.nickname
        }
        self:AcceptFriendRequestInSender(sender.Entity.Name)
    end
    self:AcceptFriendRequestInOwner(sender, result, self.Entity.Name)
end
```

**친구 관계 해제:**
```lua
@ExecSpace("ServerOnly")
method void Unfriend(string userId)
    if not self.isLoaded then return end
    
    if not self.friendTable[userId] then
        self:UnfriendInOwner(userId, self.Entity.Name)
        return
    end
    
    -- 상대방이 온라인인 경우 양방향 해제
    local other = _UserService:GetUserEntityByUserId(userId)
    if isvalid(other) and isvalid(other.Character) then
        other.Character.friendTable[self.Entity.Name] = nil
        self:UnfriendInOther(userId)
    end
    
    self.friendTable[userId] = nil
    self:UnfriendInOwner(userId, self.Entity.Name)
end
```

## 서버 측 친구 정보 조회 (Map.mlua)

### 친구 목록 조회

```lua
@ExecSpace("ServerOnly")
method void GetFriends(Character character, table userIdArray)
    if not isvalid(character) then return end
    
    local friendTable = {}
    for _, userId in ipairs(userIdArray) do
        local userEntity = _UserService:GetUserEntityByUserId(userId)
        if isvalid(userEntity) and isvalid(userEntity.Character) then
            local friend = userEntity.Character
            if friend.isLoaded then
                friendTable[userId] = {
                    nickname = friend.nickname,
                    profileCode = friend.profileCode,
                    majorRank = friend:GetMajorRank(),
                    location = friend:GetLocation()
                }
            end
        end
    end
    
    local friendArray = {}
    for i, userId in ipairs(userIdArray) do
        friendArray[i] = friendTable[userId]
    end
    
    self:GetFriendsInSender(userIdArray, friendArray, character.Entity.Name)
end
```

### 친구 팔로우 시스템

```lua
@ExecSpace("ServerOnly")
method void Follow(Character character, string userId, table friend)
    if not isvalid(character) then return end
    if character.friendTable[userId] == nil then return end
    if character.isMatching then return end
    
    -- 친구의 위치로 이동하는 로직 구현
    -- 채널, 방, 게임 모드에 따른 이동 처리
end
```

## 데이터 구조

### friendTable 구조
```lua
friendTable = {
    [userId] = {
        profileCode = "1234",
        nickname = "친구닉네임"
    }
}
```

### friendRequestArray 구조
```lua
friendRequestArray = {
    character1, -- Character 객체 참조
    character2,
    -- ...
}
```

### friend 위치 정보 구조
```lua
location = {
    mode = "Lobby" | "RankedMatch" | "FriendlyMatch" | "Practice" | "Tutorial",
    channel = { id = 1 },
    room = { channel = { id = 1 }, id = 1 }
}
```

## 이벤트 시스템

### 클라이언트 이벤트

**GetFriends 이벤트:**
- 친구 목록 정보 수신 시 발생
- 친구 슬롯 UI 업데이트에 사용

**Unfriend 이벤트:**
- 친구 관계 해제 시 발생
- UI에서 해당 친구 슬롯 제거에 사용

```lua
character.Entity:SendEvent(_Event:Unfriend(userId))
```

## 특별 기능

### 듀얼 관전 시스템 연동
친구가 되면 서로의 듀얼을 관전할 수 있는 기능이 자동으로 활성화됩니다.

```lua
-- 친구 수락 시 관전 권한 설정
if isvalid(self.player) and not isvalid(sender.player) and self.player.duel.isDueling then
    self.player.commandManager:SetWatching(sender, self.player)
end
```

### 실시간 상태 업데이트
- 친구 목록은 5초마다 자동 갱신됩니다
- 온라인 상태, 위치, 랭크 정보가 실시간 업데이트됩니다

### UI/UX 특징

**페이지네이션:**
- 한 페이지당 7명의 친구 표시
- 좌우 화살표로 페이지 이동

**시각적 피드백:**
- 온라인 친구는 랭크 아이콘 표시
- 오프라인 친구는 랭크 아이콘 숨김
- 위치별 상태 메시지 표시

**사운드 피드백:**
- 버튼 클릭 시 적절한 사운드 재생
- 친구 신청/해제 시 UI 사운드 제공

이 친구 시스템은 메이플 듀얼의 소셜 경험을 풍부하게 만드는 핵심 요소로, 플레이어 간의 지속적인 관계 형성과 상호작용을 촉진합니다.
